<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VuePress</title>
    <meta name="description" content="">
    <link rel="icon" href="/vuepress-theme-material/favicon.ico">
  <link rel="manifest" href="/vuepress-theme-material/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/vuepress-theme-material/assets/css/0.styles.1e4ac3ea.css" as="style"><link rel="preload" href="/vuepress-theme-material/assets/js/app.dbad28eb.js" as="script"><link rel="preload" href="/vuepress-theme-material/assets/js/3.fe83ecb2.js" as="script"><link rel="prefetch" href="/vuepress-theme-material/assets/js/6.44169d46.js"><link rel="prefetch" href="/vuepress-theme-material/assets/js/1.6e0a6e76.js"><link rel="prefetch" href="/vuepress-theme-material/assets/js/2.e5d60052.js"><link rel="prefetch" href="/vuepress-theme-material/assets/js/4.02c2141f.js"><link rel="prefetch" href="/vuepress-theme-material/assets/js/5.09d521be.js"><link rel="prefetch" href="/vuepress-theme-material/assets/js/7.8abcb68f.js"><link rel="prefetch" href="/vuepress-theme-material/assets/js/8.e5914329.js"><link rel="prefetch" href="/vuepress-theme-material/assets/js/9.6ef1309f.js"><link rel="prefetch" href="/vuepress-theme-material/assets/js/10.8cadd1e6.js"><link rel="prefetch" href="/vuepress-theme-material/assets/js/11.52a179ad.js"><link rel="prefetch" href="/vuepress-theme-material/assets/js/12.91b73af2.js">
    <link rel="stylesheet" href="/vuepress-theme-material/assets/css/0.styles.1e4ac3ea.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="site-app-layout --primary-background material__indigo"><div class="site-app-layout__north"></div><div class="site-app-layout__center"><!----><div class="site-layout"><header class="site-header --ellipsis site-layout__header material__indigo__base"><b>requestAnimationFrame 实现动画 · article</b><div class="site-header__nav"><a href="/vuepress-theme-material/" class="router-link-active"><i class="icon-home"></i></a></div></header><div class="site-layout__content"><div class="site-article site-layout__content-container" style="min-height:calc(100vh - 125px);"><div class="site-article__line"></div><div class="site-article__content --white"><div class="content"><h1 id="requestanimationframe-实现动画"><a href="#requestanimationframe-实现动画" aria-hidden="true" class="header-anchor">#</a> requestAnimationFrame 实现动画</h1><p>以往JS控制的动画大多使用setInterval 或者setTimeout 每隔一段时间刷新元素的位置，来达到动画的效果，但是这种方式并不能准确地控制动画帧率，尽管主流的浏览器对于这两个函数实现的动画都有一定的优化，但是这依然无法弥补它们性能问题。主要原因是因为JavaScript的单线程机制使得其可能在有阻塞的情况下无法精确到毫秒触发。</p><p>requestAnimationFrame()方法正是为了满足高性能动画的需求而提供的API，通过setInterval方法控制的动画其调用的间隔由程序员设置，而requestAnimationFrame()无须设置调用间隔， 它自动紧跟浏览器的绘制的帧率（一般浏览器的显示帧率是60fps，差不多每帧间隔16.7ms）</p><p>就终极目的来说，requestAnimationFrame就是setTimeout。既然有了setTimeout，那还要requestAnimationFrame来干嘛。setTimeout会存在过度绘制，会造成帧丢失，继而导致动画断续显示。这也是setTimeout的定时器值推荐最小使用16.7ms的原因（16.7 = 1000 / 60, 即每秒60帧）。</p><p>浏览器可以优化并行的动画动作，更合理的重新排列动作序列，并把能够合并的动作放在一个渲染周期内完成，从而呈现出更流畅的动画效果。requestAnimationFrame就是为了这个而出现的。我所做的事情很简单，跟着浏览器的绘制走，如果浏览设备绘制间隔是16.7ms，那我就这个间隔绘制；如果浏览设备绘制间隔是10ms, 我就10ms绘制。这样就不会存在过度绘制的问题，动画不会掉帧。通过requestAnimationFrame()，JS动画能够和CSS动画/变换或SVG SMIL动画同步发生。另外，如果在一个浏览器标签页里运行一个动画，当这个标签页不可见时，浏览器会暂停它，这会减少CPU，内存的压力，节省电池电量。</p><h2 id="requestanimationframe"><a href="#requestanimationframe" aria-hidden="true" class="header-anchor">#</a> requestAnimationFrame</h2><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame" target="_blank" rel="noopener noreferrer">MDN</a>的原话：</p><blockquote><p>The window.requestAnimationFrame() method tells the browser that you wish to perform an animation and requests that the browser call a specified function to update an animation before the next repaint. The method takes as an argument a callback to be invoked before the repaint.</p></blockquote><p>window.requestAnimationFrame() 方法告诉浏览器您希望执行动画，并请求浏览器调用指定的函数在下一次重绘之前更新动画。该方法将在重绘之前调用的回调作为参数。</p><p>也可以说这个方法原理其实也就跟setTimeout/setInterval差不多，通过递归调用同一方法来不断更新画面以达到动起来的效果，但它优于setTimeout/setInterval的地方在于它是由浏览器专门为动画提供的API，在运行时浏览器会自动优化方法的调用，并且如果页面不是激活状态下的话，动画会自动暂停，有效节省了CPU开销。</p><h2 id="基本语法"><a href="#基本语法" aria-hidden="true" class="header-anchor">#</a> 基本语法</h2><pre class="language-text"><code>requestID = window.requestAnimationFrame(callback);               // Firefox 23 / IE10 / Chrome / Safari 7 (incl. iOS)
requestID = window.mozRequestAnimationFrame(callback);                // Firefox &lt; 23
requestID = window.webkitRequestAnimationFrame(callback); // Older versions Chrome/Webkit
</code></pre><p>可以直接调用，也可以通过window来调用，接收一个函数作为回调，返回一个ID值，通过把这个ID值传给window.cancelAnimationFrame()可以取消该次动画。</p><h2 id="浏览器兼容性"><a href="#浏览器兼容性" aria-hidden="true" class="header-anchor">#</a> 浏览器兼容性</h2><p>就目前来说，主流现代浏览器都对它提供了支持。可以去这里查看更详细的兼容性( http://caniuse.com/#search=requestAnimationFrame )。</p><h2 id="封装"><a href="#封装" aria-hidden="true" class="header-anchor">#</a> 封装</h2><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> lastTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> vendors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'webkit'</span><span class="token punctuation">,</span> <span class="token string">'moz'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> vendors<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>window<span class="token punctuation">.</span>requestAnimationFrame<span class="token punctuation">;</span> <span class="token operator">++</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span>requestAnimationFrame <span class="token operator">=</span> window<span class="token punctuation">[</span>vendors<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'RequestAnimationFrame'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        window<span class="token punctuation">.</span>cancelAnimationFrame <span class="token operator">=</span> window<span class="token punctuation">[</span>vendors<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'CancelAnimationFrame'</span><span class="token punctuation">]</span> <span class="token operator">||</span>    <span class="token comment">// name has changed in Webkit</span>
                                      window<span class="token punctuation">[</span>vendors<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'CancelRequestAnimationFrame'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>requestAnimationFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span><span class="token function-variable function">requestAnimationFrame</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> currTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> timeToCall <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16.7</span> <span class="token operator">-</span> <span class="token punctuation">(</span>currTime <span class="token operator">-</span> lastTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> id <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">callback</span><span class="token punctuation">(</span>currTime <span class="token operator">+</span> timeToCall<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> timeToCall<span class="token punctuation">)</span><span class="token punctuation">;</span>
            lastTime <span class="token operator">=</span> currTime <span class="token operator">+</span> timeToCall<span class="token punctuation">;</span>
            <span class="token keyword">return</span> id<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>cancelAnimationFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span><span class="token function-variable function">cancelAnimationFrame</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">clearTimeout</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><p>这是网上比较推荐的兼容做法。</p><h2 id="推荐"><a href="#推荐" aria-hidden="true" class="header-anchor">#</a> 推荐</h2><ul><li><p>setInterval控制的动画与requestAnimationFrame()的效果的对比可以看(  http://www.cnblogs.com/aaronjs/p/4283109.html )</p></li><li><p>张鑫旭也深入浅出的阐释了该方法( http://www.zhangxinxu.com/wordpress/2013/09/css3-animation-requestanimationframe-tween-%E5%8A%A8%E7%94%BB%E7%AE%97%E6%B3%95/ )注意前方高能</p></li><li><p>结合canvas去做的动画( http://www.webhek.com/post/requestanimationframe.html )</p></li><li><p>一篇非常详细的介绍jquery动画源码的文章 ( http://www.iteye.com/topic/786984 ) 虽然目前jquery已经不是主流，但也有一定的学习价值。</p></li><li><p>这一篇更直观的给出了jquery动画的分析图例( http://nuysoft.iteye.com/blog/1172137 )。</p></li><li><p>这一篇对translate和改变top/left进行动画做了对比( http://www.tuicool.com/articles/UfYJb2E )</p></li></ul><h2 id="参考链接"><a href="#参考链接" aria-hidden="true" class="header-anchor">#</a> 参考链接</h2><ul><li>https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame</li><li>https://segmentfault.com/a/1190000008246652</li><li>https://segmentfault.com/a/1190000004039023</li></ul><h2 id="写在最后"><a href="#写在最后" aria-hidden="true" class="header-anchor">#</a> 写在最后</h2><p>对requestAnimationFrame做了一个封装结合vue实现scrollTop/scrollLeft滚动条滚动的缓动动画，详细的请看这里( https://github.com/wuyaoxing/vue-scroll-animate )。</p><p>0425更新</p><h2 id="补充一个缓动动画js小算法"><a href="#补充一个缓动动画js小算法" aria-hidden="true" class="header-anchor">#</a> 补充一个缓动动画JS小算法</h2><p>原理如下：</p><p>假设要从数值A变化到数值B，如果是线性运动，则每次移动距离是一样；如果是缓动，每次移动距离不一样。那如何才能不一样呢？很简单，按比例移动就可以。</p><p>例如：每次移动剩余距离的一半。</p><p>用一个简单的公式表示就是：</p><blockquote><p>A = A + (B - A) / 2</p></blockquote><p>这个简单的公式就是常用、易记的缓动小算法。我们可以结合requestAnimationFrame一起使用。</p><pre class="language-js"><code><span class="token comment">// requestAnimationFrame的兼容处理</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>requestAnimationFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">requestAnimationFrame</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">_easeout</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> rate<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">var</span> _end <span class="token operator">=</span> end<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> end <span class="token operator">||</span> <span class="token keyword">typeof</span> start <span class="token operator">!=</span> ‘number’<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
end <span class="token operator">=</span> end <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
rate <span class="token operator">=</span> rate <span class="token operator">||</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">step</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
start <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token punctuation">(</span>end – start<span class="token punctuation">)</span> <span class="token operator">/</span> rate<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>start – _end<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token comment">// if (start &lt; 1) {</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">callback</span><span class="token punctuation">(</span>end<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">callback</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

调用
<span class="token keyword">var</span> doc <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop <span class="token operator">!==</span> undefined <span class="token operator">?</span> document<span class="token punctuation">.</span>body <span class="token punctuation">:</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">,</span> doc<span class="token punctuation">.</span>scrollTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">_easeout</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span>scrollTop<span class="token punctuation">,</span> end<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
doc<span class="token punctuation">.</span>scrollTop <span class="token operator">=</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>参数</strong>：</p><ul><li>start是起始位置</li><li>end是目标位置</li><li>rate是缓动速率</li><li>callback是变化的位置回调，支持两个参数，value和isEnding，表示当前的位置值（数值）以及是否动画结束了（布尔值）</li></ul><p><strong>参考链接</strong></p><ul><li>http://www.zhangxinxu.com/wordpress/2017/01/share-a-animation-algorithm-js/</li><li>http://www.zhangxinxu.com/wordpress/2016/12/how-use-tween-js-animation-easing/</li></ul></div></div></div><footer class="site-footer --ellipsis site-layout__footer"><div class="site-footer__copyright material__indigo__darken-3">
        Copyright © 2018-present Wuyaoxing's Blog
    </div><div class="site-footer__theme material__indigo__darken-4">
        Power by
        <a href="https://vuepress.vuejs.org" target="_blank">VuePress</a> Theme
        <a href="https://github.com/wuyaoxing/vuepress-theme-material" target="_blank">material</a></div></footer></div></div></div><div class="site-app-layout__south"></div></div></div>
    <script src="/vuepress-theme-material/assets/js/3.fe83ecb2.js" defer></script><script src="/vuepress-theme-material/assets/js/app.dbad28eb.js" defer></script>
  </body>
</html>
